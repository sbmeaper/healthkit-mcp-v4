{
  "data_query": {
    "llm": {
      "model": "ollama/qwen2.5-coder:7b",
      "endpoint": "http://localhost:11434",
      "api_key": "",
      "prompt_format": {
        "structure": "ddl-samples-hints-question",
        "include_sample_rows": true,
        "sample_row_count": 8,
        "hint_style": "sql_comment",
        "response_prefix": "SELECT"
      }
    },
    "database": {
      "parquet_path": "/Users/scottbartlow/PycharmProjects/healthkit_export_ripper_one_table/health.parquet",
      "db_path": "",
      "table_name": "health",
      "max_retries": 3
    },
    "semantic_layer": {
      "auto_queries": [
        "SELECT type, COUNT(*) as row_count FROM {query_target} GROUP BY type ORDER BY row_count DESC LIMIT 30",
        "SELECT DISTINCT source_name FROM {query_target} WHERE source_name IS NOT NULL ORDER BY source_name"
      ],
      "static_context": [
        "=== DATABASE ENGINE ===",
        "DuckDB syntax only. Use CAST(start_date AS TIMESTAMP) for date operations.",

        "=== APPLE HEALTHKIT DATA MODEL ===",
        "This table contains Apple HealthKit export data. Each row is a health sample.",
        "The 'type' column identifies what kind of health data (stripped of HK prefixes).",
        "Data spans Dec 2020 to present (~5.6 million rows).",

        "=== DATE HANDLING ===",
        "start_date and end_date are VARCHAR in format 'YYYY-MM-DD HH:MM:SS'.",
        "For date filtering: WHERE start_date >= '2024-01-01' AND start_date < '2024-01-02'",
        "For TIMESTAMP operations: CAST(start_date AS TIMESTAMP)",
        "To extract date part: CAST(start_date AS DATE) or start_date::DATE",
        "For 'today': WHERE CAST(start_date AS DATE) = CURRENT_DATE",
        "For 'yesterday': WHERE CAST(start_date AS DATE) = CURRENT_DATE - INTERVAL '1 day'",
        "For 'this week': WHERE CAST(start_date AS DATE) >= DATE_TRUNC('week', CURRENT_DATE)",
        "For 'last 7 days': WHERE CAST(start_date AS TIMESTAMP) >= CURRENT_TIMESTAMP - INTERVAL '7 days'",
        "For 'this month': WHERE start_date >= DATE_TRUNC('month', CURRENT_DATE)::VARCHAR",
        "For 'last night' (sleep): WHERE start_date >= (CURRENT_DATE - INTERVAL '1 day')::VARCHAR || ' 18:00:00' AND start_date < CURRENT_DATE::VARCHAR || ' 12:00:00'",
        "For 'last month': WHERE CAST(start_date AS DATE) >= DATE_TRUNC('month', CURRENT_DATE) - INTERVAL '1 month' AND CAST(start_date AS DATE) < DATE_TRUNC('month', CURRENT_DATE)",

        "=== APPLE ACTIVITY RINGS ===",
        "The 3 Activity Rings correspond to: Move (ActiveEnergyBurned), Exercise (AppleExerciseTime), Stand (AppleStandHour)",
        "'How are my rings?' or 'Activity rings' = summarize all three for today",
        "'Move ring' or 'red ring' = ActiveEnergyBurned (goal typically 300-600 Cal)",
        "'Exercise ring' or 'green ring' = AppleExerciseTime (goal typically 30 min)",
        "'Stand ring' or 'blue ring' = AppleStandHour (goal is 12 hours with value_category='Stood')",

        "=== TYPE CATEGORIES ===",
        "CUMULATIVE TYPES (use SUM): StepCount, DistanceWalkingRunning, DistanceCycling, ActiveEnergyBurned, BasalEnergyBurned, FlightsClimbed, AppleExerciseTime, AppleStandTime, TimeInDaylight",
        "DISCRETE TYPES (use AVG/MIN/MAX): HeartRate, RestingHeartRate, WalkingHeartRateAverage, HeartRateVariabilitySDNN, BodyMass, BodyMassIndex, BodyFatPercentage, OxygenSaturation, RespiratoryRate, VO2Max, WalkingSpeed, WalkingStepLength",
        "CATEGORY TYPES (count or filter by value_category): SleepAnalysis, AppleStandHour, MindfulSession, HighHeartRateEvent, AudioExposureEvent",
        "WORKOUT TYPES (use duration_min, distance_km, energy_kcal): WorkoutCycling, WorkoutWalking, WorkoutHiking, WorkoutPickleball, WorkoutFunctionalStrengthTraining, WorkoutHighIntensityIntervalTraining, WorkoutElliptical, WorkoutCoreTraining, WorkoutYoga, WorkoutDownhillSkiing, WorkoutRunning",

        "=== COMMON USER QUERY PATTERNS ===",
        "Questions often include time phrases: 'today', 'yesterday', 'last night', 'this week', 'last 7 days', 'this month', 'last month'",
        "Aggregation words: 'total', 'average', 'how much', 'how many', 'what was my', 'what's my'",
        "Trend questions: 'how has my X changed', 'is my X improving', 'compare to last week', 'trend'",

        "=== EXAMPLE USER QUESTIONS (Siri-style) ===",
        "'How much sleep did I get last night?' -> SleepAnalysis, filter by last night's date range",
        "'How many steps have I taken today?' -> StepCount, SUM(value), today's date",
        "'How are my Activity Rings?' -> summarize ActiveEnergyBurned, AppleExerciseTime, AppleStandHour for today",
        "'What was my resting heart rate this week?' -> RestingHeartRate, AVG(value), last 7 days",
        "'How much deep sleep did I get?' -> SleepAnalysis WHERE value_category='AsleepDeep'",
        "'What's my average heart rate during workouts?' -> HeartRate during workout time ranges",
        "'How many calories have I burned today?' -> ActiveEnergyBurned, SUM(value), today",
        "'What's my VO2 max?' -> VO2Max, most recent value",
        "'How many flights did I climb this week?' -> FlightsClimbed, SUM(value), last 7 days",
        "'What's my weight trend?' -> BodyMass, ORDER BY start_date, show progression",
        "'How long did I cycle yesterday?' -> WorkoutCycling, SUM(duration_min), yesterday",
        "'Did I hit my stand goal?' -> AppleStandHour WHERE value_category='Stood', COUNT for today",
        "'What was my best workout this month?' -> Workout types, MAX(duration_min) or MAX(energy_kcal)",
        "'How's my HRV trending?' -> HeartRateVariabilitySDNN, AVG by day over time",
        "'Compare my steps this week to last week' -> StepCount, SUM by week, compare two periods",

        "=== NATURAL LANGUAGE TO TYPE MAPPINGS ===",
        "'steps' or 'step count' or 'how many steps' = type='StepCount'",
        "'walking distance' or 'running distance' or 'how far did I walk/run' = type='DistanceWalkingRunning'",
        "'cycling distance' or 'bike distance' or 'how far did I ride/cycle' = type='DistanceCycling'",
        "'calories burned' or 'active calories' or 'move calories' or 'how many calories' = type='ActiveEnergyBurned'",
        "'resting calories' or 'basal calories' or 'BMR' = type='BasalEnergyBurned'",
        "'total calories' or 'all calories' = SUM both ActiveEnergyBurned and BasalEnergyBurned",
        "'heart rate' or 'HR' or 'pulse' or 'bpm' = type='HeartRate'",
        "'resting heart rate' or 'RHR' or 'resting HR' = type='RestingHeartRate'",
        "'HRV' or 'heart rate variability' or 'SDNN' = type='HeartRateVariabilitySDNN'",
        "'weight' or 'body weight' or 'how much do I weigh' = type='BodyMass' (unit: lb)",
        "'body fat' or 'fat percentage' = type='BodyFatPercentage' (unit: %)",
        "'BMI' or 'body mass index' = type='BodyMassIndex'",
        "'sleep' or 'how did I sleep' or 'sleep quality' or 'hours of sleep' = type='SleepAnalysis'",
        "'stand hours' or 'standing' or 'did I stand' = type='AppleStandHour'",
        "'exercise minutes' or 'exercise time' or 'workout minutes' or 'activity minutes' = type='AppleExerciseTime'",
        "'flights climbed' or 'floors' or 'stairs' or 'flights of stairs' = type='FlightsClimbed'",
        "'VO2 max' or 'cardio fitness' or 'cardiovascular fitness' = type='VO2Max'",
        "'blood oxygen' or 'SpO2' or 'oxygen saturation' or 'O2' = type='OxygenSaturation'",
        "'breathing rate' or 'respiratory rate' or 'breaths per minute' = type='RespiratoryRate'",
        "'walking speed' or 'pace' or 'how fast do I walk' = type='WalkingSpeed' (unit: mi/hr)",
        "'cycling' or 'bike ride' or 'bike workout' or 'rode my bike' = type='WorkoutCycling'",
        "'walk' or 'walking workout' or 'went for a walk' = type='WorkoutWalking'",
        "'hike' or 'hiking' or 'went hiking' = type='WorkoutHiking'",
        "'pickleball' or 'played pickleball' = type='WorkoutPickleball'",
        "'strength training' or 'weights' or 'lifting' or 'resistance training' or 'gym workout' = type='WorkoutFunctionalStrengthTraining' or type='WorkoutTraditionalStrengthTraining'",
        "'HIIT' or 'interval training' or 'high intensity' = type='WorkoutHighIntensityIntervalTraining'",
        "'elliptical' or 'elliptical machine' = type='WorkoutElliptical'",
        "'core' or 'ab workout' or 'core training' = type='WorkoutCoreTraining'",
        "'yoga' or 'did yoga' = type='WorkoutYoga'",
        "'skiing' or 'snow sports' or 'went skiing' = type='WorkoutDownhillSkiing' or type='WorkoutSnowSports'",
        "'time in daylight' or 'sunlight' or 'outdoor time' = type='TimeInDaylight'",
        "'mindful minutes' or 'meditation' or 'mindfulness' = type='MindfulSession'",

        "=== SLEEP ANALYSIS ===",
        "SleepAnalysis uses value_category, NOT value column.",
        "Sleep stages: 'InBed', 'Awake', 'AsleepCore' (light sleep), 'AsleepDeep', 'AsleepREM', 'AsleepUnspecified'",
        "To get total sleep time: SUM the duration between start_date and end_date WHERE value_category IN ('AsleepCore','AsleepDeep','AsleepREM','AsleepUnspecified')",
        "Sleep duration calculation: EXTRACT(EPOCH FROM (CAST(end_date AS TIMESTAMP) - CAST(start_date AS TIMESTAMP)))/3600.0 AS hours",
        "For sleep on a given night, look for records starting after 6pm the previous day through noon the next day.",
        "'time in bed' = value_category='InBed'",
        "'deep sleep' = value_category='AsleepDeep'",
        "'light sleep' or 'core sleep' = value_category='AsleepCore'",
        "'REM sleep' = value_category='AsleepREM'",
        "'time awake' (during sleep) = value_category='Awake'",

        "=== STAND HOURS ===",
        "AppleStandHour uses value_category: 'Stood' (met goal) or 'Idle' (did not stand).",
        "Count stand hours: COUNT(*) WHERE type='AppleStandHour' AND value_category='Stood'",

        "=== WORKOUT QUERIES ===",
        "Workouts have NULL in 'value' column. Use duration_min for workout duration.",
        "distance_km and energy_kcal may be NULL for some workouts.",
        "Count workouts: COUNT(*) WHERE type LIKE 'Workout%'",
        "Workout duration is in minutes (duration_min column).",
        "For 'how long did I cycle', use: SUM(duration_min) WHERE type='WorkoutCycling'",

        "=== AGGREGATION RULES ===",
        "DAILY STEPS: SUM(value) WHERE type='StepCount' GROUP BY CAST(start_date AS DATE)",
        "DAILY DISTANCE: SUM(value) WHERE type='DistanceWalkingRunning' GROUP BY CAST(start_date AS DATE)",
        "DAILY CALORIES: SUM(value) WHERE type='ActiveEnergyBurned' GROUP BY CAST(start_date AS DATE)",
        "AVG HEART RATE: AVG(value) WHERE type='HeartRate'",
        "MAX HEART RATE: MAX(value) WHERE type='HeartRate'",
        "MIN RESTING HR: MIN(value) WHERE type='RestingHeartRate'",
        "LATEST WEIGHT: value WHERE type='BodyMass' ORDER BY start_date DESC LIMIT 1",
        "Do NOT SUM heart rate, body mass, HRV, blood oxygen, or other discrete types.",

        "=== COMMON QUERY PATTERNS ===",
        "Daily summary: GROUP BY CAST(start_date AS DATE)",
        "Weekly summary: GROUP BY DATE_TRUNC('week', CAST(start_date AS TIMESTAMP))",
        "Monthly summary: GROUP BY DATE_TRUNC('month', CAST(start_date AS TIMESTAMP))",
        "Rolling average: Use window functions with ROWS BETWEEN",
        "Year over year: Compare same date ranges across years",

        "=== DATA SOURCES ===",
        "source_name identifies data origin: Apple Watch variants, iPhone, apps like Renpho, Foodnoms, Lifesum, AutoSleep, etc.",
        "Filter by source: WHERE source_name LIKE '%Watch%' for watch data only",
        "device_model values: 'Watch', 'iPhone', or NULL",

        "=== UNITS ===",
        "StepCount, FlightsClimbed: count",
        "DistanceWalkingRunning, DistanceCycling: mi (miles)",
        "ActiveEnergyBurned, BasalEnergyBurned: Cal (calories)",
        "HeartRate, RestingHeartRate, WalkingHeartRateAverage, RespiratoryRate: count/min",
        "BodyMass, LeanBodyMass: lb (pounds)",
        "HeartRateVariabilitySDNN: ms (milliseconds)",
        "VO2Max: mL/minÂ·kg",
        "WalkingSpeed: mi/hr",
        "OxygenSaturation, BodyFatPercentage: %",
        "AppleExerciseTime, AppleStandTime: min (minutes)",
        "Environmental/Headphone audio: dBASPL",

        "=== IMPORTANT NOTES ===",
        "Do not filter on columns unless the question explicitly mentions them.",
        "When asked about 'today', 'yesterday', 'this week', etc., filter by start_date appropriately.",
        "For questions about trends, order by date and consider using window functions.",
        "NULL values are common - use COALESCE or filter with IS NOT NULL as appropriate.",
        "Multiple samples may exist for the same time period from different sources - consider deduplication if needed.",
        "'Recovery' or 'readiness' questions: look at RestingHeartRate (lower=better), HeartRateVariabilitySDNN (higher=better), sleep quality",
        "For 'best' or 'worst' queries, use ORDER BY with LIMIT 1",
        "For 'average' over a period, use AVG() with appropriate date filter",
        "When comparing periods, use subqueries or CTEs to calculate aggregates for each period",
        "User may ask about data from specific apps - filter by source_name if mentioned (Renpho, Foodnoms, AutoSleep, etc.)"
      ]
    }
  },
  "log_query": {
    "llm": {
      "model": "ollama/qwen2.5-coder:7b",
      "endpoint": "http://localhost:11434",
      "api_key": "",
      "prompt_format": {
        "structure": "ddl-samples-hints-question",
        "include_sample_rows": true,
        "sample_row_count": 8,
        "hint_style": "sql_comment",
        "response_prefix": "SELECT"
      }
    },
    "database": {
      "db_path": "~/PycharmProjects/healthkit-mcp-v4/query_logs.duckdb",
      "table_name": "query_log",
      "max_retries": 1
    },
    "semantic_layer": {
      "auto_queries": [],
      "static_context": [
        "=== DATABASE ENGINE ===",
        "DuckDB syntax only.",

        "=== SCHEMA PURPOSE ===",
        "This table logs all NLQ-to-SQL query attempts for auditing and analysis.",

        "=== KEY COLUMNS ===",
        "request_id: Groups multiple retry attempts for a single user question.",
        "attempt_number: 1 = initial attempt, 2+ = retry after error.",
        "nlq: The original natural language question from the user.",
        "sql: The SQL generated by the LLM.",
        "success: TRUE if SQL executed without error, FALSE if it failed.",
        "error_message: Database error message when success is FALSE.",

        "=== COMMON ANALYSIS PATTERNS ===",
        "Success rate: COUNT(*) FILTER (WHERE success) * 100.0 / COUNT(*)",
        "Questions needing retries: WHERE attempt_number > 1",
        "Failed queries: WHERE success = FALSE",
        "Token usage: SUM(input_tokens), SUM(output_tokens)",
        "First-attempt success rate: COUNT(*) FILTER (WHERE success AND attempt_number = 1) * 100.0 / COUNT(DISTINCT request_id)",
        "Average retries needed: AVG(attempt_number) FILTER (WHERE success) for successful queries",
        "Most common errors: GROUP BY error_message ORDER BY COUNT(*) DESC"
      ]
    }
  }
}