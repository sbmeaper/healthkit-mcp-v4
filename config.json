{
  "data_query": {
    "llm": {
      "model": "openai/qwen3-8b-mlx",
      "endpoint": "http://localhost:1234/v1",
      "api_key": "lm-studio",
      "no_think": true,
      "prompt_format": {
        "structure": "ddl-samples-hints-question",
        "include_sample_rows": true,
        "sample_row_count": 8,
        "hint_style": "sql_comment",
        "response_prefix": "SELECT"
      }
    },
    "database": {
      "parquet_path": "/Users/scottbartlow/Downloads/apple_health_export/health.parquet",
      "db_path": "",
      "table_name": "health",
      "max_retries": 3
    },
    "semantic_layer": {
      "auto_queries": [
        "SELECT MetricClass, TypeCode, SQLOperations FROM read_csv_auto('/Users/scottbartlow/PycharmProjects/healthkit-mcp-v4/metric_classes.csv') ORDER BY MetricClass, TypeCode",
        "SELECT DISTINCT type, unit FROM {query_target} WHERE unit IS NOT NULL ORDER BY type",
        "SELECT type, COUNT(*) as row_count FROM {query_target} GROUP BY type ORDER BY row_count DESC LIMIT 30",
        "SELECT DISTINCT source_name FROM {query_target} WHERE source_name IS NOT NULL ORDER BY source_name"
      ],
      "static_context": [
        "=== TABLE OVERVIEW ===",
        "The health table contains Apple HealthKit data flattened into a single table. All record types (metrics, workouts, sleep, etc.) share the same schema. The 'type' column distinguishes record types and maps to a MetricClass (see metric_classes.csv) which determines the correct aggregation: SUM for Cumulative, AVG/MIN/MAX for Discrete, COUNT for Event.",
        "Some columns are type-specific: 'value' is the numeric measurement (NULL for workouts and category-based types); 'value_category' is used by SleepAnalysis and AppleStandHour instead of value; 'duration_min', 'distance_km', 'energy_kcal' are workout-specific; 'start_lat', 'start_lon' are GPS coordinates for workouts only.",

        "=== METRIC CLASS DEFINITIONS ===",
        "Cumulative: Multiple records are additive within a time period. Use SUM(value).",
        "Discrete: Each record is an independent point-in-time measurement. Use AVG(value), MIN(value), or MAX(value). Never SUM.",
        "Event: Records represent occurrences, not measurements. Use COUNT(*). The value column is NULL or irrelevant.",

        "=== DATABASE ENGINE ===",
        "DuckDB syntax only. Use CAST(start_date AS TIMESTAMP) for date operations.",


        "=== NATURAL LANGUAGE TO TYPE MAPPINGS ===",
        "'steps' = StepCount",
        "'walking distance' or 'running distance' = DistanceWalkingRunning",
        "'cycling distance' = DistanceCycling",
        "'calories burned' or 'active calories' = ActiveEnergyBurned",
        "'resting calories' or 'basal calories' = BasalEnergyBurned",
        "'heart rate' or 'HR' or 'pulse' = HeartRate",
        "'resting heart rate' or 'RHR' = RestingHeartRate",
        "'HRV' or 'heart rate variability' = HeartRateVariabilitySDNN",
        "'weight' = BodyMass",
        "'body fat' = BodyFatPercentage",
        "'sleep' = SleepAnalysis",
        "'stand hours' = AppleStandHour",
        "'exercise minutes' = AppleExerciseTime",
        "'flights climbed' or 'floors' = FlightsClimbed",
        "'VO2 max' = VO2Max",
        "'blood oxygen' or 'SpO2' = OxygenSaturation",
        "'cycling' or 'bike ride' = WorkoutCycling",
        "'walk' or 'walking workout' = WorkoutWalking",
        "'hike' = WorkoutHiking",
        "'pickleball' = WorkoutPickleball",
        "'strength training' or 'weights' = WorkoutFunctionalStrengthTraining",
        "'yoga' = WorkoutYoga"
      ]
    }
  },
  "log_query": {
    "llm": {
      "model": "ollama/qwen2.5-coder:7b",
      "endpoint": "http://localhost:11434",
      "api_key": "",
      "keep_alive": "15m",
      "no_think": true,
      "prompt_format": {
        "structure": "ddl-samples-hints-question",
        "include_sample_rows": false,
        "sample_row_count": 8,
        "hint_style": "sql_comment",
        "response_prefix": "SELECT"
      }
    },
    "database": {
      "db_path": "~/PycharmProjects/healthkit-mcp-v4/query_logs.duckdb",
      "table_name": "query_log",
      "max_retries": 1
    },
    "semantic_layer": {
      "auto_queries": [],
      "static_context": [
        "=== DATABASE ENGINE ===",
        "DuckDB syntax only.",

        "=== SCHEMA PURPOSE ===",
        "This table logs all NLQ-to-SQL query attempts for auditing and analysis.",

        "=== TABLE NAME ===",
        "Always use the 'query_log' table. Do NOT use 'duckdb_logs' or other system tables.",

        "=== KEY COLUMNS ===",
        "request_id: Groups multiple retry attempts for a single user question.",
        "attempt_number: 1 = initial attempt, 2+ = retry after error.",
        "nlq: The original natural language question from the user.",
        "sql: The SQL generated by the LLM.",
        "success: TRUE if SQL executed without error, FALSE if it failed.",
        "error_message: Database error message when success is FALSE.",
        "sql_generator_llm: The LLM model used to generate the SQL (e.g., 'ollama/qwen2.5-coder:7b').",

        "=== COMMON ANALYSIS PATTERNS ===",
        "Success rate: COUNT(*) FILTER (WHERE success) * 100.0 / COUNT(*)",
        "Questions needing retries: WHERE attempt_number > 1",
        "Failed queries: WHERE success = FALSE",
        "Token usage: SUM(input_tokens), SUM(output_tokens)",
        "First-attempt success rate: COUNT(*) FILTER (WHERE success AND attempt_number = 1) * 100.0 / COUNT(DISTINCT request_id)",
        "Average retries needed: AVG(attempt_number) FILTER (WHERE success) for successful queries",
        "Most common errors: GROUP BY error_message ORDER BY COUNT(*) DESC"
      ]
    }
  }
}